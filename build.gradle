plugins {
    id 'com.moowork.node' version '0.10'
}

apply plugin: 'java'
apply plugin: 'eclipse'

version = '1.0.0-SNAPSHOT'
group = 'de.undercouch'
sourceCompatibility = '1.8'
targetCompatibility = '1.8'

repositories {
    mavenCentral()
    maven {
        url 'https://oss.sonatype.org/content/repositories/snapshots'
    }
}

configurations {
    core
    codegen
}

dependencies {
    compile 'io.vertx:vertx-core:3.0.0-milestone6'
    compile 'io.vertx:vertx-lang-js:3.0.0-milestone6'

    testCompile 'junit:junit:4.12'

    core group: 'io.vertx', name: 'vertx-core', version: '3.0.0-milestone6', classifier: 'sources'

    codegen 'io.vertx:vertx-core:3.0.0-milestone6'
    codegen 'io.vertx:vertx-codegen:3.0.0-milestone6'
    codegen 'io.vertx:vertx-docgen:3.0.0-milestone6'
    codegen 'log4j:log4j:1.2.16'
    codegen 'org.slf4j:slf4j-api:1.6.2'
}

task wrapper(type: Wrapper) {
    gradleVersion = '2.4'
}

node {
  version = '0.12.4'
  npmVersion = '2.1.6'
  download = true
}

sourceSets {
    main {
        resources {
            srcDir 'src-gen/main/resources'
        }
    }
}

task copyCore(type: Copy) {
    from {
        configurations.core.collect { zipTree(it) }
    }
    into new File(buildDir, 'core')
    include "io/vertx/core/**"
}

task generateTypeDefinitions(type: JavaCompile, dependsOn: copyCore) {
    source = new File(buildDir, 'core')
    classpath = configurations.codegen + files(sourceSets.main.resources.srcDirs)
    options.compilerArgs = [
            '-proc:only',
            '-processor', 'io.vertx.codegen.CodeGenProcessor',
            '-AoutputDirectory=' + new File(buildDir, 'generated'),
    ]
    destinationDir = new File(buildDir, 'generated')
}

task copyTypeDefinitions(type: Copy, dependsOn: generateTypeDefinitions) {
    from new File(generateTypeDefinitions.destinationDir, 'resources/vertx-typescript')
    into new File(projectDir, 'src-gen/main/resources/vertx-typescript')
}

task copyRequiredResources(type: Copy, dependsOn: [copyTypeDefinitions, npmInstall]) {
    from file('node_modules/typescript')
    into 'src-gen/main/resources/typescript'
}

processResources.dependsOn(copyRequiredResources)

eclipseClasspath.dependsOn(processResources)
